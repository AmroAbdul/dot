"use strict";(()=>{var W=document,Y=browserStorage.sync.getItem("bm_pref__contacts__lastname");function K(e){return Array.isArray(e)&&0!==e.length?e:null}cjce.registerTemplate("bm-p-contactswithgapi",function(o,r){var s,l,d,m,u,i,e,p="https://contacts.google.com"+r.wizPath+"/",U="https://people.googleapis.com/v1/",x="https://www.google.com/m8/feeds/",n=["https://www.googleapis.com/auth/contacts.readonly"],c=40,a=window.devicePixelRatio||2,F=Math.ceil(c*a),h=p,b="home",_=null,D=25,R=["contactGroups/coworkers","contactGroups/family","contactGroups/friends"],f=!1,t=Y.then(function(e){f=Boolean(e)}),g="connections(resourceName,names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId),nextPageToken",j=null,y=!1,C=(()=>cjgApis.info.getIsConsumerGmail(r.account)?Promise.resolve(!1):cjgApis.cache.getItem(r.account,"bm_pref__contacts__directory").then(function(e){return"boolean"==typeof e?e:w().then(function(){return!0},function(){return!1}).then(function(e){return cjgApis.cache.setItem(r.account,"bm_pref__contacts__directory",e),e})}))().then(function(e){e&&(y=!0,g=g.replace("resourceName,","resourceName,metadata/sources(type,id),"))}),v=!1,N={};function q(){return cjgApis.info.getUserDomain(r.account).then(function(e){e=cjBasics.urlParams.attach(x+"gal/"+(e||"default")+"/full",{alt:"json","max-results":"50000"});return cjgApis.request(e,{fetchAs:"json",headers:{"GData-Version":"1.0"}},{account:r.account,requiredScopes:n})}).then(function(e){var i=[],e=e&&e.feed&&e.feed.entry;return Array.isArray(e)&&e.forEach(function(e){var a,t,n,c=(e=>{if(!(e=e.id&&e.id.$t&&e.id.$t.split("full/P.")[1]))return null;for(var a=cjBasics.numbers.hex2dec(e);a.length<20;)a="0"+a;return a=a.length<21?"1"+a:a})(e);c&&(a=c="people/"+c,(e=(e=e).gd$name)&&(t=e.gd$fullName&&e.gd$fullName.$t,n=e.gd$givenName&&e.gd$givenName.$t,e=e.gd$familyName&&e.gd$familyName.$t,N[a]={displayName:t||n||e,displayNameLastFirst:e&&n?e+", "+n:null}),i.push(c))}),i})}function w(){return j=j||q()}function E(e){var a=(e=>{var a=e.resourceName;if(y&&a.startsWith("people/c")){var t=e.metadata&&e.metadata.sources;if(Array.isArray(t))for(var n=0;n<t.length;n++)if("DOMAIN_PROFILE"===t[n].type)return"people/"+t[n].id}return a})(e),t=e&&e.names&&e.names[0]||N[a];if(t){var n,c=t.displayName||"",t=t.displayNameLastFirst||c;if(c)return n=[],Array.isArray(e.memberships)&&(n=e.memberships.map(function(e){return e.contactGroupMembership?e.contactGroupMembership.contactGroupId:"GSUITE_DIRECTORY_GROUP"})),{id:a,displayName:c,displayNameLastFirst:t,sortValue:c.toLowerCase(),sortValueLastFirst:t.toLowerCase(),photo:e.photos&&e.photos[0].url||null,memberships:n}}}function $(e){for(var a=[],t=[],n=0;n<e.length;n+=50){var c=L("people:batchGet",{resourceNames:e.splice(0,50),fields:"responses(requestedResourceName,person(names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId))",personFields:"names,photos,memberships"}).then(function(e){e.responses.forEach(function(e){e.person.resourceName=e.requestedResourceName;e=E(e.person);e&&a.push(e)})});t.push(c)}return Promise.all(t).then(function(){return a})}function T(e,a){u.cjceSetLoading(!0),b=e,_=a,v&&P()}function S(e){var t=f?"sortValueLastFirst":"sortValue";e.sort(function(e,a){return e[t]<a[t]?-1:1})}function M(){Promise.all([cjgApis.cache.getItem(r.account,"bm_cache_v33__contacts__library"),t]).then(function(e){v||(s=e[0])&&(v=!0,P())}),Promise.all([C,t]).then(function(e){var a=((e,a,t,n)=>{var c=t||[];return L(t="other"===e?"otherContacts":"people/me/connections",{pageToken:n,pageSize:"2000",personFields:"memberships,metadata,names,photos",fields:g,sortOrder:a}).then(function(e){return Array.isArray(e.connections)&&(e.connections.forEach(function(e){e=E(e);e&&c.push(e)}),e.nextPageToken,0),c})})("main",f?"LAST_NAME_ASCENDING":"FIRST_NAME_ASCENDING");return y?Promise.all([w().then($),a]).then(function(e){var a=e[0],e=e[1],t=a.map(function(e){return e.id});return e.forEach(function(e){-1===t.indexOf(e.id)&&a.push(e)}),S(a),a}):a}).then(function(e){v=!0,s&&JSON.stringify(s).length===JSON.stringify(e).length||(cjgApis.cache.setItem(r.account,"bm_cache_v33__contacts__library",e),s=e,P())})}function L(a,t){var e=t||{},e=(e.prettyPrint="false",cjBasics.urlParams.attach(U+a,e));return cjgApis.request(e,{fetchAs:"json"},{account:r.account,requiredScopes:n}).catch(function(){return new Promise(function(e){setTimeout(function(){L(a,t).then(e)},4e3)})})}function A(){return cjce.createElement("ccbm-fabgroup",{items:[cjce.createElement("gmd-fab",{label:cjBasics.lang.i18n("cj_i18n_01285","Create contact"),onClick:function(){r.openTab(p+"new")}})]})}function B(e,a,t){return"string"!=typeof e?"/images/avatar.svg":((e=e.startsWith("http://")?e.replace("http://","https://"):e).startsWith("https://www.google.com/s2/")&&(e=e.replace("www","profiles")),cjgFrontend.urls.getAvatar(e,a,t))}function I(e,a){e=p+e.replace("people/","person/");a&&(e+="?edit=true"),r.openTab(e)}function G(a){return s.filter(function(e){return-1!==e.memberships.indexOf(a)})}function k(e,a){var n=W.createDocumentFragment();a.forEach(function(e){a=e,e=f&&a.displayNameLastFirst||a.displayName,t={size:c},a.photo?(t.url=B(a.photo,0,F),t.avatar=!0):(t.withShell=!0,t.symbol=e[0]||"-"),(t=cjce.createElement("cjmd-item",{icon:t,label:e})).classList.add("bm-p-contactswithgapi-listitem"),t.cjceContactsData=a,(e=cjce.createElement("ccbm-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){I(a.id,!0)}})).classList.add("bm-p-contactswithgapi-listitem__tool"),t.appendChild(e),(e=cjce.createElement("ccbm-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_01545","Open in a new tab"),iconName:"__mdi:open_in_new",onClick:function(){I(a.id)}})).classList.add("bm-p-contactswithgapi-listitem__tool"),t.appendChild(e);var a,t,e=t;n.appendChild(e)}),e.appendChild(n)}function P(){u.cjceSetLoading(!0);var t,a,n,e,c,i=cjce.createElement("cjmd-container",{scrollable:!0,fabPadding:!0,infiniteScroll:!0,shadow:"thinOnScroll"});"home"===b?(0<(e=G("starred")).length&&(c=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00004","Starred")}),i.appendChild(c),k(c=cjce.createElement("cjmd-list"),e),i.appendChild(c),e=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")}),i.appendChild(e)),t=G("myContacts")):"search"===b?(a=_,t=s.filter(function(e){return-1!==JSON.stringify(e).indexOf(a)})):"directory"===b?t=G("GSUITE_DIRECTORY_GROUP"):"other"===b?t=G("SPECIAL_OTHER"):"label"===b&&(t=G(_)),0<t.length?(n=cjce.createElement("cjmd-list"),function e(){var a=t.splice(0,D);k(n,a),0!==t.length&&setTimeout(function(){i.cjceSetInfiniteScroll(e)})}(),i.appendChild(n)):(c=b,e=cjce.createElement("cjmd-emptystate",{color:!0,label:cjBasics.lang.i18n("cj_i18n_01275","No contacts found"),subLabel:"search"===c?cjBasics.lang.i18n("cj_i18n_00116","Try a synonym or more general keyword"):null,iconName:"search"===c?"__mdi:search":"__mdi:contacts_product"}),i.appendChild(e)),d.textContent="",d.appendChild(i),u.cjceSetLoading(!1)}function V(e,a){var t=a.resourceName.replace("contactGroups/",""),n=a.formattedName,c=n,a=a.memberCount;0<a&&(c+=" ("+a+")"),e.push({id:t,iconName:"__mdi:label",label:c,navigatorLabel:n,newTabUrl:p+"label/"+t})}function z(){cjce.applyTemplate(m,"bm-loading");var n=[{id:"home",iconName:"__mdi:person",label:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),navigatorLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),newTabUrl:p},{iconName:"__mdi:history",label:cjBasics.lang.i18n("cj_i18n_01276","Frequently contacted"),newTabUrl:p+"frequent",external:!0},{iconName:"__mdi:archive",label:cjBasics.lang.i18n("cj_i18n_01278","Other contacts"),newTabUrl:p+"other",divider:!0}],c=[{iconName:"__mdi:assistant",label:cjBasics.lang.i18n("cj_i18n_01277","Duplicates"),newTabUrl:p+"suggestions",external:!0},{iconName:"__mdi:delete",label:cjBasics.lang.i18n("cj_i18n_00005","Trash"),newTabUrl:p+"trash",external:!0,divider:!0}],i=W.createElement("div"),e=(m.appendChild(i),L("contactGroups",{pageSize:"500",fields:"contactGroups(resourceName,groupType,formattedName,memberCount)"}));Promise.all([e,t,C]).then(function(e){var t=[],a=(y&&(n[0].divider=!1,n.push({id:"directory",label:cjBasics.lang.i18n("cj_i18n_01279","Directory"),iconName:"__mdi:business",newTabUrl:p+"directory",divider:!0})),e[0].contactGroups.forEach(function(e){var a;"USER_CONTACT_GROUP"===e.groupType?V(t,e):"contactGroups/myContacts"===e.resourceName?0<(a=e.memberCount)&&(n[0].label+=" ("+a+")"):-1!==R.indexOf(e.resourceName)&&0<e.memberCount&&V(t,e)}),0<t.length&&(n.push({header:!0,label:cjBasics.lang.i18n("cj_i18n_01280","Labels")}),t.sort(function(e,a){return e.label.toLowerCase()<a.label.toLowerCase()?-1:1}),t[t.length-1].divider=!0,n=n.concat(t)),n=n.concat(c),l=cjce.createElement("bm-navlist",{compact:!0,isSelector:!0,selectedId:"home",items:n,onChange:function(e,a){h=a.newTabUrl||p,"home"===e||"directory"===e||"other"===e?T(e):T("label",e),u.cjceSetPageLabel(a.navigatorLabel||a.label)},onNewTab:function(e,a){r.openTab(a.newTabUrl)}}),i.appendChild(l),cjce.createElement("bm-drawerdropdown",{iconName:"__mdi:cj_sort_by_alpha",label:cjBasics.lang.i18n("cj_i18n_01281","Sort"),selectedId:f?"last":"first",items:[{value:"last",label:cjBasics.lang.i18n("cj_i18n_01282","Sort by last name")},{value:"first",label:cjBasics.lang.i18n("cj_i18n_01283","Sort by first name")}],onChange:function(){var e;e="last"===a.cjceSelectedId,f=e,browserStorage.sync.setItem("bm_pref__contacts__lastname",f),v&&(S(s),P())}}));m.appendChild(a),m.cjceSetLoading(!1)})}function O(a){var e=cjce.createElement("cjmd-item"),t=cjce.createElement("ccbm-iconbutton",{iconName:"__mdi:content_copy",label:cjBasics.lang.i18n("cj_i18n_07125","Copy to clipboard"),onClick:function(e){cjBasics.clipboard.copy(a.value),i||(i=cjce.createElement("ccbm-snackbar",{label:cjBasics.lang.i18n("cj_i18n_07124","Copied to clipboard")}),o.appendChild(i)),i.cjceShow()}}),n=(a.onClick?e.addEventListener("click",function(e){e=e.target;e===t||t.contains(e)||a.onClick()}):e.classList.add("no-action"),cjce.createElement("cjmd-icon",{name:a.iconName})),n=(e.appendChild(n),W.createElement("div")),c=(n.className="cjmd-item__body",e.appendChild(n),W.createElement("div"));return c.className="cjmd-item__header",c.textContent=a.value,n.appendChild(c),a.subLabel&&(c=cjce.createElement("cjmd-secondarytext",{label:a.subLabel}),n.appendChild(c)),e.appendChild(t),e}function H(e){e=encodeURIComponent(e);r.openTab(p+"search/"+e)}function J(){var e=l.cjceSelectedId;"home"===e||"directory"===e||"other"===e?T(e):T("label",e)}u=cjce.createElement("bm-ogb",{loading:!0,drawer:!0,serviceIcon:"contacts",serviceLabel:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),pageLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),searchbox:{color:!0,onClear:J,onInput:function(e){e?T("search",e):J()},onSubmit:function(){d.querySelector(".cjmd-item").click()},onMetaSubmit:H},bmApis:r,onNewTab:function(){"search"===b?H(_):r.openTab(h)}}),o.appendChild(u),m=u.cjceDrawerEl,a=u.cjceSearchboxEl,e=A(),o.appendChild(e),r.setOnPageDisplayHandler(a.select),(d=cjce.createElement("cjmd-container")).addEventListener("click",function(e){var a,t,c,n,i,e=e.target.cjceContactsData;e&&(a=e,(t=cjce.createElement("cjmd-container",{solid:!0})).classList.add("bm-p-contactswithgapi-details"),e=cjce.createElement("bm-ogb",{floating:!0,displayBack:!0,onBack:function(){t.remove()},bmApis:r,onNewTab:function(){I(a.id)}}),t.appendChild(e),n=cjce.createElement("ccbm-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){I(a.id,!0)}}),e.cjceAppendChild(n),(c=W.createElement("div")).className="bm-p-contactswithgapi-details__top",t.appendChild(c),e=f&&a.displayNameLastFirst||a.displayName,n={size:80},a.photo?(n.url=B(a.photo,80),n.avatar=!0):(n.symbol=e[0]||"-",n.withShell=!0),(n=cjce.createElement("cjmd-icon",n)).classList.add("bm-p-contactswithgapi-details__photo"),c.appendChild(n),(n=cjce.createElement("cjmd-title",{label:e})).classList.add("bm-p-contactswithgapi-details__name"),c.appendChild(n),e=cjce.createElement("cjmd-container",{scrollable:!0,shadow:"thickOnScroll"}),t.appendChild(e),i=cjce.createElement("cjmd-list"),e.appendChild(i),L(a.id,{fields:"addresses,birthdays,emailAddresses,phoneNumbers"}).then(function(e){var t=W.createDocumentFragment(),a=K(e.emailAddresses),n=(a&&a.forEach(function(e){var a=O({iconName:"__mdi:email",value:e.value,subLabel:e.formattedType,onClick:function(){r.openTab("mailto:"+e.value)}});t.appendChild(a)}),K(e.phoneNumbers));n&&n.forEach(function(e){var a=O({iconName:"__mdi:call",value:e.value,subLabel:e.formattedType,onClick:function(){r.openTab("tel:"+e.canonicalForm)}});t.appendChild(a)}),a&&(n=a[0].value,a=[{iconName:"__mdi:email",label:cjBasics.lang.i18n("cj_i18n_07233","Send email"),newTabUrl:"mailto:"+n},{iconName:"__mdi:event",label:cjBasics.lang.i18n("cj_i18n_07234","Schedule event"),newTabUrl:cjBasics.urlParams.attach("https://meet.google.com/new",{authuser:"0"===r.account.authuser?null:r.account.authuser,calleeId:n})},{iconName:"__mdi:meet",label:cjBasics.lang.i18n("cj_i18n_07235","Start video call"),newTabUrl:cjBasics.urlParams.attach("https://calendar.google.com/calendar/r/eventedit",{authuser:"0"===r.account.authuser?null:r.account.authuser,add:n})}],n=cjce.createElement("ccbm-biglinks",{bottom:!0,items:a,onClick:function(e,a){a=a.newTabUrl;r.openTab(a)}}),c.appendChild(n)),Array.isArray(e.addresses)&&0<e.addresses.length&&e.addresses.forEach(function(e){var a=O({iconName:"__mdi:place",value:e.formattedValue,subLabel:e.formattedType,onClick:function(){r.openTab(cjBasics.urlParams.attach("https://maps.google.com/",{authuser:"0"===r.account.authuser?null:r.account.authuser,q:e.formattedValue}))}});t.appendChild(a)}),Array.isArray(e.birthdays)&&0<e.birthdays.length&&e.birthdays.forEach(function(e){e=O({iconName:"__mdi:cake",value:e.text});t.appendChild(e)}),0===t.children.length&&((a=W.createElement("div")).className="bm-p-contactswithgapi-noinfo",a.textContent=cjBasics.lang.i18n("cj_i18n_01284","No more contact info found"),t.appendChild(a)),i.appendChild(t),u.cjceSetLoading(!1)}),o.appendChild(t))}),o.appendChild(d),M(),z(),cjgApis.auth.requireToken(r.account,n).catch(function(e){var a=cjce.createElement("bm-fulldialog",{bmApis:r,onNewTab:function(){r.openTab(h)},lockup:{label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")},iconName:"contacts",message:cjBasics.lang.i18n("cj_i18n_01286","Before you can use this page, you need to give access to load your Google Contacts"),actionLabel:cjBasics.lang.i18n("cj_i18n_01916","Continue with Google"),actionG:!0,action:function(){cjgApis.auth.requestPermissions(r.account,e.cjg_missing_scopes)}}),t=A();a.appendChild(t),o.appendChild(a)})})})();